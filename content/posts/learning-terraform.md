---
author: "Spencer Nicol"
date: "2023-01-31"
title: "Terraform with GCP"
categories: ["terraform", "gcp"]
description: "Notes from learning all about Terraform with GCP (Google Cloud Platform)"
authorImageUrl: "https://media.publit.io/file/spencer/spencer-small.webp"
imageUrl: "https://media.publit.io/file/terraformGCP/gcp-terraform.webp"
---

![Terraform + Google Cloud Platform](https://media.publit.io/file/terraformGCP/gcp-terraform.webp)

## What is Terraform?

Terraform, developed by HashiCorp, is an open-source Infrastructure-as-code (IaC) tool used for automating the process of infrastructure creation and management.

Many prefer Terraform over other IaC tools because it allows users to use the same configuration language to define the same infrastructure on different cloud providers, making it quick and easy to move resources between them without the need to go back and rewrite your code.

![Infrastructure as code](https://media.publit.io/file/terraformGCP/infrastructure-as-code.webp)

## Terraform HCL

Terraform HCL (HashiCorp Configuration Language) is a custom language developed by HashiCorp for describing infrastructure configurations. HCL is a declarative language, which means that it uses human-readable syntax for describing what should be done rather than the steps necessary to do it. HCL supports the construction of complex data structures and has built-in features like expressions, variables, and conditionals.

Here's a quick example of some Terraform HCL code that would be saved in an `.tf` file. This code uses the `local_file` resource and creates a file named `hello-world.txt` with the provided `content`.

```hcl
// main.tf
resource "local_file" "sample" {
  filename = "hello-world.txt"
  content  = "Hello world, from Terraform"
}
```

## Basic Shell commands:

1. `terraform init` initializes a working directory containing Terraform configuration files. It is the first command that should be run after writing a new Terraform configuration or cloning an existing one from version control. It is safe to run this command multiple times.

2. `terraform plan` is used to create an execution plan. Terraform performs a refresh, unless explicitly disabled, and then determines what actions are necessary to achieve the desired state specified in the configuration files.

3. `terraform apply` is used to apply the changes required to reach the desired state of the configuration, or the pre-determined set of actions generated by a terraform plan execution plan. Alternatively, you can apply a specific solution by passing it into terraform apply.

## Variables

Variables allow a user to input custom values when launching a Terraform configuration, and you can also set default values for variables that must be adjusted by the user.

```hcl
// variables.tf
variable "filename" {
  type    = string
  default = "sample.txt"
}
variable "content" {
  type    = string
  default = "I am loving Terraform"
}
```

```hcl
// main.tf
resource "local_file" "sample_res" {
  filename = var.filename
  content  = var.content
}
```

Variable can also be referenced inline:

```hcl
resource "random_string" "rstr" {
  length = 15
}

resource "local_file" "sample_res" {
  filename = "sample.txt"
  content  = "I love random text ${random_string.rstr.id}"
}
```

### Variable Types

The following are all the variable types supported by Terraform:

#### String

```hcl
variable "string_example" {
  type    = string
  default = "Dogs are awesome!"
}
```

#### Bool

```hcl
variable "bool_example" {
  type    = bool
  default = false
}
```

#### Number

```hcl
variable "number_example" {
  type    = number
  default = 23
}
```

#### Map

```hcl
variable "map_example" {
  type    = map(any)
  default = { name = "Spencer", age = 37 }
}
```

#### Object

```hcl
variable "object_example" {
  type = object({
    size  = number
    color = string
  })
  default = {
    size  = 5
    color = "blue"
  }
}
```

#### Tuple

```hcl
variable "tuple_example" {
  type    = tuple([string, bool, number])
  default = ["red", false, 23]
}
```

#### List

Ordered collection of elements which may contain duplicates

```hcl
variable "list_example" {
  type    = list(string)
  default = ["red", "green", "blue", "blue"]
}
```

#### Set

Unordered collection of unique elements

```hcl
variable "set_example" {
  type    = set(string)
  default = ["blue", "red", "green"]
}
```

## Provider Version

The `required_providers` block in Terraform is used to define which providers a module needs in order to run. This block ensures that each of the defined providers are available before attempting to use the module. It also provides information about the correct configuration options for each provider. This block also helps ensure that other modules that may depend on this module are also able to use the same providers.

```hcl
// main.tf
terraform {
  required_providers {
    random = {
      source  = "hashicorp/random"
      version = "2.3.1"
    }
  }
}

provider "random" {
  # Configuration options
}

resource "random_integer" "rint" {
  min = 0
  max = 100
}
```

## Lifecycle

```hcl
resource "random_integer" "rint" {
  min = 31
  max = 350

  lifecycle {
    create_before_destroy = true
    prevent_destroy = true
    ignore_changes = [min, max]
  }
}
```

1. The `create_before_destroy` lifecycle is used to create a resource before destroying another resource. This is commonly used when replacing an existing resource with a new one of the same type, such as when upgrading a virtual machine.

2. The `prevent_destroy` lifecycle is used to keep a resource from being destroyed. This can be useful when a resource is linked to other resources and must be preserved.

3. The `ignore_changes` lifecycle is used when a resource must remain unchanged, even if the configuration is changed elsewhere. This can be useful when setting a resource to a locked state, since it will ignore any attempts to alter its configuration.

## Data

A Terraform data source is a way to access data elements in other external services or files.

```hcl
data "local_file" "name" {
  filename = "sample_data.txt"
}

output "name1" {
  value = data.local_file.name.content
}
```

## What is GCP?

Google Cloud Platform (GCP) is an infrastructure as a service that can be used with Terraform.

Terraform supports GCP in various ways, including Google Cloud Platform (GCP) resource, data source, and module resources.

Developers can use Terraform to provision and manage GCP resources, including compute and storage, as well as to configure settings, such as account and access control settings. In addition, Terraform can be used to create custom GCP resources and manage deployments, such as creating an automated deployment pipeline.

With Terraform, users can efficiently manage GCP resources and reduce the need for manual, manual tasks.

![Google Cloud Platform Provider](https://media.publit.io/file/terraformGCP/gcp-provider.webp)

### Create a Google Cloud Free Trial Account

1. Visit the Google Cloud Platform website, and click the `Try It Free` button.

2. Enter your personal information and create an account.

3. Choose your country or region.

4. Read and accept the Terms of Service and Privacy Policy.

5. Choose the type of account you would like to use.

6. Enter your payment information, including a valid credit card. You will not be charged if you use the free trial options.

7. Select the options you want to include in your trial account.

8. Follow any additional steps required by the setup wizard to complete your account setup.

### Create a new project

1. Log into the Google Cloud Platform Console.

2. In the top right corner, click the radio button next to the project you wish to add a project to.

3. Click on the `New Project` button.

4. Enter the project name and select the data center region for the project.

5. Click on `Create`.

6. The project will be added to the list of active project in the Google Cloud Platform Console.

### Create a Service Account

A service account allows you to authenticate to Google Cloud Platform and access the necessary APIs to deploy and manage infrastructure with Terraform. With the service account, you can grant the Terraform infrastructure running in the cloud access to other Google Cloud Platform resources without having to enter credentials.

1. Log in to the Google Cloud Platform Console and select your project from the drop down window.

2. Select `IAM & Admin` option from the left sidebar and go to `Service Accounts` tab.

3. Click on `Create service account` from the top.

4. Enter the service account name and brief description of use.

5. Enter the email address you want associated with the service account.

6. Select the IAM roles you wish to assign to the service account.

7. Finally, select `furnish a new private key` and click `Create` button.

This will create the service account with the selected roles, email address and private key. You can download the private key and use it while authenticating with this service account.

## Get started with GCP as Terraform Provider

The Google provider is used to configure your [Google Cloud Platform infrastructure](https://registry.terraform.io/providers/hashicorp/google/latest/docs).

- Create Terraform script that includes google provider

  ```hcl
  // main.tf
  terraform {
    required_providers {
      google = {
        source  = "hashicorp/google"
        version = "4.51.0"
      }
    }
  }

  provider "google" {
    # Configuration options
  }
  ```

- Run shell script from main.tf directory

  ```bash
  terraform init
  ```

- Connect with GCP
  - Google Provider Configuration: projectId, zone, region
  - Multiple ways to authenticate with GCP
    1. Username/password (_gcloud auth application-default logic_)
    2. Google Cloud VM
    3. Service account keys (_preferred in production_)
  - Create Google Cloud Storage bucket
    ```hcl
    resource "google_storage_bucket" "gcs1" {
      name = "bucketname"
    }
    ```
